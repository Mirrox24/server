<!DOCTYPE html>
<html lang="ru" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–°–±–µ—Ä—ë–Ω–æ–∫ | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–æ–º–æ—â–Ω–∏–∫</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f0f4f9;
            --bg-card: #ffffff; --bg-modal: #ffffff;
            --text-primary: #1c1c1c; --text-secondary: #606060; --accent: #4CAF50;
            --accent-light: #e8f5e9; --border-color: #e0e0e0; --balance-text-color: #ffffff;
            --danger-color: #ef4444; --danger-light-color: #fee2e2;
        }
        html.dark {
            --bg-main: #1f2937;
            --bg-card: #374151; --bg-modal: #2b3544;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --accent-light: #2e7d32;
            --border-color: #4b5563; --balance-text-color: #ffffff; --danger-color: #f87171;
            --danger-light-color: #450a0a;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #d1d5db;
            color: var(--text-primary); transition: background-color 0.3s, color 0.3s;
        }
        .phone-frame { 
            max-width: 420px;
            height: 100vh; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        @media (min-width: 421px) { 
            .phone-frame { 
                height: 90vh;
                max-height: 850px; 
                border: 12px solid #111827; border-radius: 48px; 
            } 
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.4s ease-out forwards; }
        .modal-content { animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-backdrop { animation: fadeInBackdrop 0.3s ease-out forwards; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes fadeInBackdrop {
            from { background-color: rgba(0,0,0,0); } to { background-color: rgba(0,0,0,0.5); }
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); }
        }
        .xp-bar-fill, .goal-progress-bar { transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .card-animate { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card-animate:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04); }
        body { --accent: var(--user-accent-color, #4CAF50); }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: var(--text-secondary);
            border-radius: 50%; display: inline-block; animation: blink 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0% { opacity: 0.2; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.2; transform: scale(0.8); }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        .nav-btn.active svg, .nav-btn.active span { color: var(--accent) !important; font-weight: 600; }
        
        input[type="checkbox"]:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
  })
}
</script>

</head>
<body class="bg-gray-300 dark:bg-gray-800 flex items-center justify-center">

    <div id="app-container" class="phone-frame bg-[var(--bg-main)] flex flex-col w-full overflow-hidden">
        <main class="flex-1 overflow-y-auto relative p-6 space-y-6"></main>
        <footer class="flex-shrink-0 bg-[var(--bg-card)] border-t border-[var(--border-color)] grid grid-cols-6 gap-2 px-2 py-3" id="nav-footer"></footer>
    </div>
    
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>
    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center gap-2 w-full max-w-sm px-4"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let pieChart;
    const GIGACHAT_API_URL = 'https://server-5knc.onrender.com/api/chat';
    const XP_PER_LEVEL = 100;
    const BRIGHT_COLORS = ['#ff9f40', '#4bc0c0', '#ffcd56', '#9966ff', '#36a2eb', '#ff6384', '#4caf50' ];
    const characterStyles = {
        'default':   { name: '–û–±—ã—á–Ω—ã–π',   img: 'https://i.imgur.com/88egxWw.png' },
        'superhero': { name: '–ì–µ—Ä–æ–π',     img: 'https://i.imgur.com/LHuTFmV.jpeg', requiredAchievement: 'tasks_10' },
        'wizard':    { name: '–ú–∞–≥',       img: 'https://i.imgur.com/iG3eHks.png', requiredAchievement: 'savings_1000' },
        'artist':    { name: '–•—É–¥–æ–∂–Ω–∏–∫',  img: 'https://i.imgur.com/EaVleOk.jpeg',   requiredAchievement: 'lessons_5' },
        'astronaut': { name: '–ö–æ—Å–º–æ–Ω–∞–≤—Ç', img: 'https://imgur.com/Gm6TZjM.png',  requiredAchievement: 'goals_3' },
        'detective': { name: '–°—ã—â–∏–∫',     img: 'https://i.imgur.com/fxUIXDS.png', requiredAchievement: 'spending_10' },
    };
    const achievementConfig = {
        'tasks_1':      { name: '–ü–µ—Ä–≤—ã–π —à–∞–≥',       description: '–í—ã–ø–æ–ª–Ω–∏—Ç—å 1 –∑–∞–¥–∞—á—É',        goalKey: 'completedTasks',   goalValue: 1,    xp: 10,  unlockedSkin: null },
        'tasks_10':     { name: '–î–µ—Å—è—Ç–∫–∞!',         description: '–í—ã–ø–æ–ª–Ω–∏—Ç—å 10 –∑–∞–¥–∞—á',       goalKey: 'completedTasks',   goalValue: 10,   xp: 50,  unlockedSkin: 'superhero' },
        'savings_1000': { name: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å',       description: '–ù–∞–∫–æ–ø–∏—Ç—å 1000 ‚ÇΩ',          goalKey: 'totalSavings',     goalValue: 1000, xp: 100, unlockedSkin: 'wizard' },
        'lessons_1':    { name: '–£—á–µ–Ω–∏–∫',           description: '–ü—Ä–æ–π—Ç–∏ 1 —É—Ä–æ–∫',            goalKey: 'lessonsCompleted', goalValue: 1,    xp: 20,  unlockedSkin: null },
        'lessons_5':    { name: '–ó–Ω–∞—Ç–æ–∫',           description: '–ü—Ä–æ–π—Ç–∏ 5 —É—Ä–æ–∫–æ–≤',          goalKey: 'lessonsCompleted', goalValue: 5,    xp: 75,  unlockedSkin: 'artist' },
        'goals_3':      { name: '–¶–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª—ë–Ω–Ω—ã–π', description: '–î–æ—Å—Ç–∏—á—å 3 —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–∏', goalKey: 'goalsAchieved',    goalValue: 3,    xp: 150, unlockedSkin: 'astronaut' },
        'spending_10':  { name: '–ê–Ω–∞–ª–∏—Ç–∏–∫',         description: '–ó–∞–ø–∏—Å–∞—Ç—å 10 —Ä–∞—Å—Ö–æ–¥–æ–≤',     goalKey: 'spendingCount',    goalValue: 10,   xp: 40,  unlockedSkin: 'detective' },
    };
    const spendingCategories = {
        '–ï–¥–∞':       { color: BRIGHT_COLORS[1], icon: 'üçî' }, '–ò–≥—Ä—ã':      { color: BRIGHT_COLORS[0], icon: 'üéÆ' }, 
        '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': { color: BRIGHT_COLORS[2], icon: 'üé¨' }, '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': { color: BRIGHT_COLORS[3], icon: 'üöå' }, 
        '–ü–æ–¥–∞—Ä–∫–∏':   { color: BRIGHT_COLORS[4], icon: 'üéÅ' }, '–ü—Ä–æ—á–µ–µ':    { color: BRIGHT_COLORS[5], icon: 'üõí' }, 
    };
    const academyLessons = {
        'money-101': { title: '–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–Ω—å–≥–∏?', icon: 'üí∞', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–µ–±–µ–Ω–∫—É 10 –ª–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–Ω—å–≥–∏, –∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø–æ—á–µ–º—É –æ–Ω–∏ –Ω–µ —Ä–∞—Å—Ç—É—Ç –Ω–∞ –¥–µ—Ä–µ–≤—å—è—Ö.' },
        'budget-basics': { title: '–ë—é–¥–∂–µ—Ç: 4 –∫–æ–Ω–≤–µ—Ä—Ç–∞', icon: 'üìä', xp: 25, prompt: '–∫–∞–∫ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –±—é–¥–∂–µ—Ç –∏–∑ –∫–∞—Ä–º–∞–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥? –û–±—ä—è—Å–Ω–∏ –ø—Ä–∞–≤–∏–ª–æ "4 –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤" –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ, –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä —Å —Å—É–º–º–æ–π 500 —Ä—É–±–ª–µ–π –≤ –Ω–µ–¥–µ–ª—é.' },
        'discounts-intro': { title: '–°–∫–∏–¥–∫–∏: –í—ã–≥–æ–¥–∞ –∏–ª–∏ –ª–æ–≤—É—à–∫–∞?', icon: 'üè∑Ô∏è', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–∫–∏–¥–∫–∏, –∏ –Ω–∞—É—á–∏ –æ—Ç–ª–∏—á–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –≤—ã–≥–æ–¥—É –æ—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —É–ª–æ–≤–æ–∫. –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä —Å –ø–æ–∫—É–ø–∫–æ–π –∫—Ä–æ—Å—Å–æ–≤–æ–∫.' },
        'savings-why': { title: '–ö–æ–ø–∏–ª–∫–∞ vs. –ë–∞–Ω–∫', icon: 'üè¶', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–µ–Ω–µ–≥ –≤ –∫–æ–ø–∏–ª–∫–µ –∏ –≤ –±–∞–Ω–∫–µ, –∞ —Ç–∞–∫–∂–µ —á—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫. –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ä–æ—Å—Ç–µ –¥–µ–Ω–µ–≥.' },
        'first-card': { title: '–ú–æ—è –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞', icon: 'üí≥', xp: 30, prompt: '—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –≥–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã. –ß—Ç–æ —Ç–∞–∫–æ–µ –ü–ò–ù-–∫–æ–¥, CVV –∏ –ø–æ—á–µ–º—É –∏—Ö –Ω–µ–ª—å–∑—è –Ω–∏–∫–æ–º—É –≥–æ–≤–æ—Ä–∏—Ç—å?' },
        'online-scammers': { title: '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –º–æ—à–µ–Ω–Ω–∏–∫–∏!', icon: 'üëª', xp: 30, prompt: '–æ–ø–∏—à–∏ 3 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –æ–±–º–∞–Ω–∞ –¥–µ—Ç–µ–π –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–µ–π–∫–æ–≤—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã, –ø—Ä–æ—Å—å–±—ã "–¥—Ä—É–∑–µ–π" –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö) –∏ –∫–∞–∫ –Ω–∞ –Ω–∏—Ö –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è.' },
        'needs-vs-wants': { title: '–•–æ—á—É vs. –ù–∞–¥–æ', icon: 'ü§î', xp: 30, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏ (–µ–¥–∞, –æ–¥–µ–∂–¥–∞) –∏ –∂–µ–ª–∞–Ω–∏—è–º–∏ (–Ω–æ–≤–∞—è –∏–≥—Ä–∞, —Å–ª–∞–¥–æ—Å—Ç–∏). –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞—Ö?' },
        'earning-first-money':{ title: '–ü–µ—Ä–≤—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫', icon: 'üõ†Ô∏è', xp: 30, prompt: '–ø—Ä–µ–¥–ª–æ–∂–∏ 4-5 –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π, –∫–∞–∫ –ø–æ–¥—Ä–æ—Å—Ç–æ–∫ 12-14 –ª–µ—Ç –º–æ–∂–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ –∫–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ (–ø–æ–º–æ—â—å —Å–æ—Å–µ–¥—è–º, –≤—ã–≥—É–ª —Å–æ–±–∞–∫ –∏ —Ç.–¥.).' }
    };
    const DOM = { main: document.querySelector('main'), nav: document.getElementById('nav-footer'), modal: document.getElementById('modal-container'), toast: document.getElementById('toast-container'), appContainer: document.querySelector('body'), };
    let appState = {}; 

    function loadState() {
        const savedState = JSON.parse(localStorage.getItem('sberenokState_v17_final'));
        const defaultState = {
            ui: { currentView: 'home', theme: 'light', isAiTyping: false, accentColor: '#4CAF50', isChatInitiated: false, isFirstLaunch: true, },
            user: { 
                name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", 
                surname: "", 
                characterStyle: 'default', 
                balance: 1350.75, 
                level: 1, 
                xp: 10, 
                goals: [{ id: Date.now(), name: "–ö—Ä—É—Ç–æ–π —Å–∫–µ–π—Ç–±–æ—Ä–¥ üõπ", current: 2800, target: 4500 }], 
                schedule: [ 
                    { id: 1, task: "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π", done: false, xpEarned: false }, 
                    { id: 2, task: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–ª–∞–≤–∞–Ω–∏—é", done: true, xpEarned: true }, 
                    { id: 3, task: "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –±–∞–±—É—à–∫–µ", done: false, xpEarned: false }, 
                ], 
                spendingHistory: [], 
                stats: { completedTasks: 1, totalSavings: 2800, lessonsCompleted: 0, goalsAchieved: 0, spendingCount: 0 }, 
                unlockedSkins: ['default'], 
                completedLessons: [], 
                achievements: [], 
                proactiveTipsShown: { spendingAnalysis: false, goalMotivation: false, academyWelcome: false } 
            },
            chat: { history: [] },
        };
        appState = savedState || defaultState;
        appState.ui.currentView = 'home';
        appState.ui.isChatInitiated = false; 
        applyTheme(); 
        saveState();
    }
    
    function saveState() { localStorage.setItem('sberenokState_v17_final', JSON.stringify(appState)); }
    function render() { renderNav(); renderView(); }
    function navigate(viewId) { appState.ui.currentView = viewId; render(); }
    
    function renderNav() {
        const buttons = [
            { id: 'home', icon: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>', label: '–ì–ª–∞–≤–Ω–∞—è' },
            { id: 'piggy-bank', icon: '<path d="M10 18V8a4 4 0 1 1 8 0v10M2 22h20"/>', label: '–ö–æ–ø–∏–ª–∫–∞' },
            { id: 'ai-assistant', icon: '<path d="M12 8V4H8"/> <rect width="16" height="12" x="4" y="8" rx="2"/> <path d="M2 14h2"/> <path d="M20 14h2"/> <path d="M15 13v2"/> <path d="M9 13v2"/>', label: '–°–±–µ—Ä—ë–Ω–æ–∫' },
            { id: 'schedule', icon: '<rect width="18" height="18" x="3" y="4" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>', label: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ' },
            { id: 'academy', icon: '<path d="m4 6 8-4 8 4 8-4"/> <path d="M4 10v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10"/>', label: '–ê–∫–∞–¥–µ–º–∏—è' },
            { id: 'profile', icon: '<circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/>', label: '–ü—Ä–æ—Ñ–∏–ª—å' }
        ];
        DOM.nav.innerHTML = buttons.map(btn => `<button data-action="navigate" data-view="${btn.id}" class="nav-btn flex flex-col items-center text-gray-500 dark:text-gray-400 text-xs space-y-1 transition-colors duration-200 ${appState.ui.currentView === btn.id ? 'active' : ''}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${btn.icon}</svg><span>${btn.label}</span></button>`).join('');
    }

    async function renderView() {
        const viewId = appState.ui.currentView;
        let content = '';
        const contextualHelpButton = (prompt, persona) => `<button data-action="show-ai-help" data-prompt="${prompt}" data-persona="${persona}" title="–°–ø—Ä–æ—Å–∏—Ç—å –°–±–µ—Ä—ë–Ω–∫–∞" class="absolute top-2 right-1 w-12 h-12 bg-[var(--accent)] text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 7.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/><path d="M5 21v-2a4.4 4.4 0 0 1 4.4-4.4h5.2A4.4 4.4 0 0 1 19 19v2"/></svg></button>`;
        
        if (viewId === 'academy' && !appState.user.proactiveTipsShown.academyWelcome) {
            setTimeout(() => {
                showProactiveToast(
                    '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ê–∫–∞–¥–µ–º–∏—é! –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å —É–∑–Ω–∞—Ç—å –º–Ω–æ–≥–æ –Ω–æ–≤–æ–≥–æ –æ –¥–µ–Ω—å–≥–∞—Ö. –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å?',
                    '–ù–∞—á–∞—Ç—å —É—á–∏—Ç—å—Å—è!',
                    '–ö–∞–∫–æ–π —É—Ä–æ–∫ –º–Ω–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ–π—Ç–∏ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã –ª—É—á—à–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ–Ω—å–≥–∞–º–∏?',
                    'academy-tutor'
                );
                appState.user.proactiveTipsShown.academyWelcome = true;
                saveState();
            }, 500);
        }

        switch(viewId) {
            case 'home': content = getHomeHTML(); break;
            case 'piggy-bank': content = getPiggyBankHTML() + contextualHelpButton('–î–∞–π –º–Ω–µ 3 —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö —Å–æ–≤–µ—Ç–∞, –∫–∞–∫ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞–∫–æ–ø–∏—Ç—å –Ω–∞ –º–æ—é —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å.', 'financial-analyst'); break;
            case 'schedule': content = getScheduleHTML() + contextualHelpButton('–ü–æ–º–æ–≥–∏ –º–Ω–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞, —á—Ç–æ–±—ã –≤—Å–µ —É—Å–ø–µ—Ç—å.', 'planner'); break;
            case 'academy': content = getAcademyHTML() + contextualHelpButton('–ö–∞–∫–æ–π —É—Ä–æ–∫ –º–Ω–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ–π—Ç–∏ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã –ª—É—á—à–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ–Ω—å–≥–∞–º–∏?', 'academy-tutor'); break;
            case 'profile': content = getProfileHTML(); break;
            case 'ai-assistant': content = getChatAssistantHTML(); break;
        }
        DOM.main.innerHTML = `<div class="view active relative">${content}</div>`;
        if (viewId === 'piggy-bank') setTimeout(renderCharts, 50);
        if (viewId === 'ai-assistant') renderChatMessages();
        if (appState.ui.isFirstLaunch) { startOnboarding(); appState.ui.isFirstLaunch = false; saveState(); }
    }
    
    function getHomeHTML() {
        const charImg = characterStyles[appState.user.characterStyle].img;
        const tasksLeft = appState.user.schedule.filter(t => !t.done).length;
        const totalSavings = appState.user.goals.reduce((sum, g) => sum + g.current, 0);
        return `<div class="flex items-center justify-between mb-6"><div><h1 class="text-3xl font-extrabold text-[var(--text-primary)]">–ü—Ä–∏–≤–µ—Ç, ${appState.user.name}!</h1><p class="text-[var(--text-secondary)]">–í–æ—Ç —Ç–≤–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã —Å–µ–≥–æ–¥–Ω—è.</p></div><img src="${charImg}" class="w-14 h-14 rounded-full border-2 border-[var(--accent)] shadow-md"></div><div class="bg-[var(--accent)] p-6 rounded-2xl shadow-xl card-animate text-[var(--balance-text-color)]"><p class="text-lg opacity-90">–ú–æ–π –±–∞–ª–∞–Ω—Å</p><p class="text-5xl font-extrabold mt-1">${appState.user.balance.toFixed(2)} ‚ÇΩ</p><div class="flex justify-between mt-4 border-t border-white/30 pt-3 text-sm"><span>–í—Å–µ–≥–æ –≤ –∫–æ–ø–∏–ª–∫–∞—Ö:</span><span class="font-semibold">${totalSavings.toFixed(2)} ‚ÇΩ</span></div></div><h2 class="text-xl font-bold mt-8 mb-3">–ú–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å</h2>${appState.user.goals.length > 0 ?
        appState.user.goals.slice(0, 1).map(goal => { const progress = Math.min(100, (goal.current / goal.target) * 100); return `<div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-md card-animate"><h3 class="font-bold text-lg">${goal.name}</h3><p class="text-sm text-[var(--text-secondary)]">${goal.current.toFixed(0)} ‚ÇΩ –∏–∑ ${goal.target.toFixed(0)} ‚ÇΩ</p><div class="w-full bg-[var(--border-color)] rounded-full h-3 my-2 overflow-hidden"><div class="bg-[var(--accent)] h-3 rounded-full goal-progress-bar" style="width: ${progress}%"></div></div><button data-action="navigate" data-view="piggy-bank" class="mt-2 text-sm font-medium text-[var(--accent)]">–í—Å–µ —Ü–µ–ª–∏ ‚Üí</button></div>`; }).join('') : `<div class="bg-[var(--bg-card)] p-4 rounded-xl text-center shadow-md text-[var(--text-secondary)]">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π. <button data-action="navigate" data-view="piggy-bank" class="font-bold text-[var(--accent)]">–ù–∞—á–∞—Ç—å –∫–æ–ø–∏—Ç—å!</button></div>`}<h2 class="text-xl font-bold mt-8 mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2><div class="grid grid-cols-3 gap-4 text-center"><button data-action="navigate" data-view="ai-assistant" class="bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 p-4 rounded-2xl shadow-sm font-medium flex flex-col items-center justify-center card-animate aspect-square"><span class="text-4xl mb-1">üí°</span><span class="text-xs">–°–±–µ—Ä—ë–Ω–æ–∫</span></button><button data-action="navigate" data-view="schedule" class="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300 p-4 rounded-2xl shadow-sm font-medium flex flex-col items-center justify-center card-animate aspect-square"><span class="text-4xl mb-1">‚úÖ</span><span class="text-xs">${tasksLeft} –ó–∞–¥–∞—á</span></button><button data-action="add-expense" class="bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300 p-4 rounded-2xl shadow-sm font-medium flex flex-col items-center justify-center card-animate aspect-square"><span class="text-4xl mb-1">üí∏</span><span class="text-xs">–¢—Ä–∞—Ç–∞</span></button></div>`;
    }

    function getPiggyBankHTML() {
        const goalsHTML = appState.user.goals.map(goal => { const progress = Math.min(100, (goal.current / goal.target) * 100); const isAchieved = goal.current >= goal.target; return `<div class="bg-[var(--bg-card)] p-5 rounded-2xl shadow-sm border-l-4 ${isAchieved ? 'border-green-500' : 'border-[var(--accent)]'}"><div class="flex items-start justify-between mb-2"><div><h3 class="font-bold text-lg">${goal.name}</h3><p class="text-md font-semibold text-[var(--text-secondary)]">${goal.current.toFixed(0)} ‚ÇΩ / ${goal.target.toFixed(0)} ‚ÇΩ</p></div><div class="flex gap-2"><button data-action="edit-goal" data-goal-id="${goal.id}" class="text-xl text-[var(--text-secondary)] hover:text-[var(--accent)] transition-transform active:scale-90">‚úèÔ∏è</button><button data-action="delete-goal" data-goal-id="${goal.id}" class="text-xl text-[var(--danger-color)] hover:opacity-75 transition-transform active:scale-90">üóëÔ∏è</button></div></div><div class="w-full bg-[var(--border-color)] rounded-full h-2.5 my-3 overflow-hidden"><div class="bg-[var(--accent)] h-2.5 rounded-full goal-progress-bar" style="width: ${progress}%"></div></div><div class="flex gap-2 justify-end mt-4"><button data-action="manage-funds" data-goal-id="${goal.id}" data-type="withdraw" class="bg-gray-200 dark:bg-gray-600 text-[var(--text-primary)] px-4 py-2 rounded-lg text-sm font-medium transition-all active:scale-95">–°–Ω—è—Ç—å</button><button data-action="manage-funds" data-goal-id="${goal.id}" data-type="deposit" class="bg-[var(--accent)] text-white px-4 py-2 rounded-lg text-sm font-medium transition-all active:scale-95">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button></div></div>`; }).join('');
        const hasExpenses = appState.user.spendingHistory.length > 0;
        return `<h1 class="text-2xl font-bold mb-4">–ú–æ—è –ö–æ–ø–∏–ª–∫–∞</h1><div class="space-y-4">${appState.user.goals.length > 0 ? goalsHTML : ''}<button data-action="add-goal" class="w-full bg-[var(--bg-card)] p-4 rounded-xl shadow-sm border-2 border-dashed border-[var(--border-color)] text-[var(--text-secondary)] font-medium transition-colors active:bg-[var(--border-color)] card-animate">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å</button></div><h2 class="text-xl font-bold mt-8 mb-3">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2><button data-action="add-expense" class="w-full bg-[var(--danger-light-color)] text-[var(--danger-color)] p-3 rounded-xl shadow-sm font-medium mb-4 transition-colors active:scale-[.99] card-animate">üí∏ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</button><div id="charts-container" class="${hasExpenses ? '' : 'hidden'}"><div class="grid grid-cols-1 gap-4"><div class="bg-[var(--bg-card)] p-4 rounded-2xl shadow-lg w-full card-animate"><h3 class="font-semibold text-sm text-left text-[var(--text-secondary)] mb-2">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3><div class="h-48 flex justify-center items-center"><canvas id="spendingPieChart"></canvas></div></div></div></div><div id="no-charts-placeholder" class="${hasExpenses ? 'hidden' : ''}"><div class="bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg text-center text-[var(--text-secondary)]"><p class="font-medium">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–≤–æ–∏—Ö —Ç—Ä–∞—Ç.</p><p class="text-sm mt-1">–ó–∞–ø–∏—à–∏ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å—Ö–æ–¥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫—Ä–∞—Å–∏–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã!</p></div></div>`;
    }

    function getScheduleHTML() {
        const tasksHTML = appState.user.schedule.map(task => `
            <div class="flex items-center gap-4 p-4 rounded-xl bg-[var(--bg-card)] shadow-sm transition-all duration-300 ${task.done ? 'bg-green-50 dark:bg-green-900/20' : ''}">
                <input 
                    id="task-${task.id}" 
                    type="checkbox" 
                    data-action="toggle-task" 
                    data-task-id="${task.id}" 
                    ${task.done ? 'checked' : ''} 
                    class="appearance-none flex-shrink-0 h-6 w-6 bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-500 rounded-md focus:ring-2 focus:ring-offset-0 focus:ring-[var(--accent)] transition-colors cursor-pointer checked:bg-[var(--accent)] checked:border-transparent"
                >
                <label for="task-${task.id}" class="flex-1 text-md font-medium ${task.done ? 'line-through text-[var(--text-secondary)]' : ''} cursor-pointer">${task.task}</label>
                <button data-action="edit-task-modal" data-task-id="${task.id}" class="text-xl text-[var(--text-secondary)] hover:text-[var(--accent)] transition-transform active:scale-90 p-1">‚úèÔ∏è</button>
                <button data-action="delete-task" data-task-id="${task.id}" class="text-xl text-[var(--danger-color)] hover:opacity-75 transition-transform active:scale-90 p-1">üóëÔ∏è</button>
            </div>`).join('');
        return `<h1 class="text-2xl font-bold mb-4">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –ó–∞–¥–∞—á–∏</h1><div class="space-y-3">${appState.user.schedule.length > 0 ? tasksHTML : `<p class="text-center text-[var(--text-secondary)] p-8 bg-[var(--bg-card)] rounded-xl">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π! üå¥</p>`}</div><button data-action="add-task-modal" class="w-full bg-[var(--bg-card)] p-4 rounded-xl shadow-sm border-2 border-dashed border-[var(--border-color)] text-[var(--text-secondary)] font-medium mt-4 transition-colors active:bg-[var(--border-color)] card-animate">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</button>`;
    }

    function getAcademyHTML() {
        return `<h1 class="text-2xl font-bold mb-4">–ê–∫–∞–¥–µ–º–∏—è –§–∏–Ω–∞–Ω—Å–æ–≤</h1><p class="text-[var(--text-secondary)] mb-6">–£—á–∏—Å—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ —Å–æ –°–±–µ—Ä—ë–Ω–∫–æ–º –∏ –ø–æ–ª—É—á–∞–π XP –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–∫!</p><div class="space-y-4">${Object.entries(academyLessons).map(([key, lesson]) => { const isCompleted = appState.user.completedLessons.includes(key); return `<button data-action="start-lesson" data-lesson-id="${key}" class="w-full text-left p-4 rounded-xl bg-[var(--bg-card)] shadow-md flex items-center justify-between transition-transform active:scale-95 card-animate border-l-4 ${isCompleted ? 'border-green-500' : 'border-blue-400'}"><div class="flex items-center gap-4"><span class="text-3xl">${lesson.icon}</span><div><span class="font-semibold">${lesson.title}</span><p class="text-sm text-[var(--text-secondary)]">+${lesson.xp} XP</p></div></div>${isCompleted ? `<span class="text-green-500 font-bold text-sm">‚úì –ü—Ä–æ–π–¥–µ–Ω–æ</span>` : '<span class="text-gray-400 font-medium text-sm">–ù–∞—á–∞—Ç—å ‚Üí</span>'}</button>` }).join('')}</div>`;
    }

    function getProfileHTML() {
        const { name, surname, level, xp, unlockedSkins, characterStyle } = appState.user;
        const progress = (xp / XP_PER_LEVEL) * 100;
        const achievementsHTML = Object.values(achievementConfig).map(ach => { const isUnlocked = appState.user.achievements.includes(ach.name); return `<div class="p-3 bg-[var(--bg-card)] rounded-lg flex items-center gap-3 border-l-4 ${isUnlocked ? 'border-green-500' : 'border-[var(--border-color)]'}"><div class="w-12 h-12 flex items-center justify-center rounded-full bg-[var(--accent-light)] text-2xl">${isUnlocked ? 'üèÜ' : 'üîí'}</div><div><h4 class="font-medium">${ach.name}</h4><p class="text-sm text-[var(--text-secondary)]">${ach.description}</p></div></div>`; }).join('');
        const colorPalette = [ { name: '–°–±–µ—Ä Green', hex: '#4CAF50' }, { name: 'Sky Blue', hex: '#2196F3' }, { name: 'Sunset Orange', hex: '#FF9800' }, { name: 'Hot Pink', hex: '#E91E63' }, { name: 'Royal Purple', hex: '#9C27B0'} ];
        return `<div class="text-center"><img src="${characterStyles[characterStyle].img}" class="w-28 h-28 rounded-full border-4 border-[var(--accent)] shadow-lg mx-auto mb-3"><h1 class="text-2xl font-bold">${name} ${surname}</h1><p class="text-sm text-[var(--text-secondary)]">–£—Ä–æ–≤–µ–Ω—å ${level}</p><div class="w-full bg-[var(--border-color)] rounded-full h-2.5 mt-2 overflow-hidden"><div class="bg-[var(--accent)] h-2.5 rounded-full xp-bar-fill" style="width: ${progress}%"></div></div><p class="text-xs text-right text-[var(--text-secondary)] mt-1">${xp} / ${XP_PER_LEVEL} XP</p></div><h2 class="text-xl font-bold mt-8 mb-3">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2><div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center text-sm"><span>${name} ${surname}</span><button data-action="edit-profile" class="text-[var(--accent)] text-sm font-medium">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button></div></div><h2 class="text-xl font-bold mt-8 mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-sm space-y-4"><button data-action="toggle-theme" class="w-full flex justify-between items-center font-medium"><span>–¢–µ–º–∞: ${appState.ui.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è ‚òÄÔ∏è' : '–¢–µ–º–Ω–∞—è üåô'}</span><span class="text-[var(--accent)]">–°–º–µ–Ω–∏—Ç—å</span></button><h3 class="font-medium text-sm border-t border-[var(--border-color)] pt-3">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</h3><div class="flex justify-around gap-2">${colorPalette.map(color => `<button data-action="change-accent-color" data-color="${color.hex}" class="w-10 h-10 rounded-full shadow-md transition-all active:scale-90" style="background-color: ${color.hex}; border: 3px solid ${appState.ui.accentColor === color.hex ? 'var(--text-primary)' : 'transparent'};" title="${color.name}"></button>`).join('')}</div></div><h2 class="text-xl font-bold mt-8 mb-3">–°–∫–∏–Ω—ã –ü–æ–º–æ—â–Ω–∏–∫–∞</h2><div class="grid grid-cols-3 sm:grid-cols-4 gap-4">${Object.entries(characterStyles).map(([key, char]) => `<div class="character-option flex flex-col items-center"><label for="char-${key}" data-action="change-character" data-char-key="${key}" class="relative w-20 h-20 rounded-full border-2 border-transparent overflow-hidden cursor-pointer transition-all active:scale-95 duration-200 ${characterStyle === key ? 'border-[var(--accent)] border-4' : 'border-[var(--border-color)]'}"><img src="${char.img}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/60 text-white font-bold rounded-full items-center justify-center text-center text-3xl ${unlockedSkins.includes(key) ? 'hidden' : 'flex'}">üîí</div></label><span class="mt-2 text-xs text-center text-[var(--text-primary)]">${char.name}</span></div>`).join('')}</div><h2 class="text-xl font-bold mt-8 mb-3">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2><div class="space-y-2">${achievementsHTML}</div>`;
    }
    
    function getChatAssistantHTML() {
        return `<h1 class="text-2xl font-bold mb-4">–°–±–µ—Ä—ë–Ω–æ–∫ ‚Äî AI –ü–æ–º–æ—â–Ω–∏–∫</h1><div id="chat-history" class="space-y-4 flex flex-col pb-4 h-[calc(100vh-400px)] overflow-y-auto bg-[var(--bg-main)] p-2 rounded-xl border border-[var(--border-color)]"></div><div id="ai-typing-indicator-container" class="h-10"><div id="ai-typing-indicator" class="flex items-center space-x-2 my-2 transition-opacity duration-300 opacity-0 ${appState.ui.isAiTyping ? 'opacity-100' : ''}"><img src="${characterStyles[appState.user.characterStyle].img}" class="w-8 h-8 rounded-full opacity-70 flex-shrink-0"><div class="text-sm text-[var(--text-secondary)] bg-[var(--bg-card)] px-3 py-1 rounded-full">–°–±–µ—Ä—ë–Ω–æ–∫ –ø–µ—á–∞—Ç–∞–µ—Ç...</div></div></div><div class="mt-2"><h3 class="font-bold mb-2 text-sm text-[var(--text-secondary)]">–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3><div class="flex gap-2 overflow-x-auto pb-2 -mx-6 px-6"><button data-action="ai-action" data-prompt="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ç—Ä–∞—Ç –∏ —Å–∫–∞–∂–∏, –≥–¥–µ —è –º–æ–≥—É —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å." data-persona="financial-analyst" class="flex-shrink-0 bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 px-3 py-1.5 rounded-full text-xs font-medium transition-all active:scale-95">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</button><button data-action="ai-action" data-prompt="–ü—Ä–µ–¥–ª–æ–∂–∏ 3 –∏–¥–µ–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º–∞–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ." data-persona="earning-ideas" class="flex-shrink-0 bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 px-3 py-1.5 rounded-full text-xs font-medium transition-all active:scale-95">–ò–¥–µ–∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</button><button data-action="ai-action" data-prompt="–î–∞–π —Å–æ–≤–µ—Ç, –∫–∞–∫ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å—Å—è –Ω–∞ –∏–≥—Ä—ã, –ø–æ–∫–∞ –¥–µ–ª–∞—é —É—Ä–æ–∫–∏." data-persona="planner" class="flex-shrink-0 bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300 px-3 py-1.5 rounded-full text-xs font-medium transition-all active:scale-95">–°–æ–≤–µ—Ç –ø–æ —Ñ–æ–∫—É—Å—É</button><button data-action="ai-action" data-prompt="–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ñ–ª—è—Ü–∏—è? –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏." data-persona="academy-tutor" class="flex-shrink-0 bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300 px-3 py-1.5 rounded-full text-xs font-medium transition-all active:scale-95">–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ñ–ª—è—Ü–∏—è?</button><button data-action="ai-action" data-prompt="–†–∞—Å—Å–∫–∞–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –Ω–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç." data-persona="educator" class="flex-shrink-0 bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-300 px-3 py-1.5 rounded-full text-xs font-medium transition-all active:scale-95">–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç</button></div></div><div class="flex gap-2 mt-4"><input type="text" id="chat-input" placeholder="–°–ø—Ä–æ—Å–∏ –°–±–µ—Ä—ë–Ω–∫–∞..." class="flex-1 p-3 rounded-xl bg-[var(--bg-card)] border border-[var(--border-color)] focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent)] text-[var(--text-primary)] transition-shadow" onkeypress="if(event.key === 'Enter') document.getElementById('send-chat-btn').click()"><button id="send-chat-btn" data-action="send-chat-message" class="bg-[var(--accent)] text-white p-3 rounded-xl shadow-md transition-all active:scale-95 hover:shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></button></div>`;
    }

    function renderChatMessages() {
        const chatHistoryEl = document.getElementById('chat-history');
        if (!chatHistoryEl) return;
        if (!appState.ui.isChatInitiated) { appState.ui.isChatInitiated = true; if(appState.chat.history.length === 0) { appState.chat.history.push({ role: 'bot', text: `–ü—Ä–∏–≤–µ—Ç, ${appState.user.name}! –Ø –°–±–µ—Ä—ë–Ω–æ–∫, —Ç–≤–æ–π —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è? üí°` }); } }
        chatHistoryEl.innerHTML = appState.chat.history.map(msg => `<div class="flex items-end gap-2 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">${msg.role === 'bot' ? `<img src="${characterStyles[appState.user.characterStyle].img}" class="w-8 h-8 rounded-full self-start flex-shrink-0">` : ''}<div class="max-w-[80%] p-3 rounded-2xl shadow-sm ${msg.role === 'user' ? 'bg-[var(--accent)] text-white rounded-br-none' : 'bg-[var(--bg-card)] text-[var(--text-primary)] rounded-tl-none'}"><p class="text-sm" style="overflow-wrap: break-word;">${msg.text.replace(/\n/g, '<br>')}</p></div></div>`).join('');
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        const typingIndicator = document.getElementById('ai-typing-indicator');
        if (typingIndicator) { typingIndicator.classList.toggle('opacity-100', appState.ui.isAiTyping); typingIndicator.classList.toggle('opacity-0', !appState.ui.isAiTyping); }
    }
    
    function processSpendingData() {
        const spending = appState.user.spendingHistory;
        const categoryTotals = {};
        spending.forEach(item => {
            const category = item.category || '–ü—Ä–æ—á–µ–µ';
            categoryTotals[category] = (categoryTotals[category] || 0) + item.amount;
        });
        const pieLabels = Object.keys(categoryTotals);
        const pieData = pieLabels.map(label => categoryTotals[label]);
        const pieColors = pieLabels.map(label => spendingCategories[label]?.color || BRIGHT_COLORS[5]);
        return { pie: { labels: pieLabels, data: pieData, colors: pieColors } };
    }

    function renderCharts() {
        const hasExpenses = appState.user.spendingHistory.length > 0;
        const chartsContainer = document.getElementById('charts-container');
        const noChartsPlaceholder = document.getElementById('no-charts-placeholder');
        if (chartsContainer) chartsContainer.classList.toggle('hidden', !hasExpenses);
        if (noChartsPlaceholder) noChartsPlaceholder.classList.toggle('hidden', hasExpenses);
        if (!hasExpenses) return;

        const pieCtx = document.getElementById('spendingPieChart');
        if (!pieCtx) { return; }
        if (pieChart) pieChart.destroy();
        
        const data = processSpendingData();
        
        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: data.pie.labels,
                datasets: [{
                    data: data.pie.data,
                    backgroundColor: data.pie.colors,
                    borderColor: 'var(--bg-card)',
                    borderWidth: 6,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                animation: { duration: 1200, easing: 'easeOutQuint', animateRotate: true, animateScale: true },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value.toFixed(2)} ‚ÇΩ`;
                            }
                        }
                    },
                    datalabels: { display: false }
                }
            }
        });
    }

    async function callGigaChatAPI(userPrompt, persona = "assistant") {
        appState.ui.isAiTyping = true;
        renderChatMessages();
        
        const systemText = (() => {
            switch (persona) {
                case 'academy-tutor': return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, –º—É–¥—Ä—ã–π –∏ –¥–æ–±—Ä—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç–µ–º—ã –¥–µ—Ç—è–º 8‚Äì16 –ª–µ—Ç. –û–±—ä—è—Å–Ω—è–π –≤—Å—ë –ø–æ–¥—Ä–æ–±–Ω–æ, –ø—Ä–∏–≤–æ–¥–∏ –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ –∂–∏–∑–Ω–∏ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–¥–µ–ª–∞—Ç—å —Å–ª–æ–∂–Ω—É—é —Ç–µ–º—É –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –Ω–µ–º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.`;
                case 'planner': return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å. –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏, —Ç–∞–π–º–∏–Ω–≥–∏ –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–æ–≤–µ—Ç—ã, —á—Ç–æ–±—ã –≤—Å—ë —É—Å–ø–µ—Ç—å –∏ –Ω–µ —É—Å—Ç–∞—Ç—å. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º üòä`;
                case 'financial-analyst': return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç–Ω–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞—Ç—ã –≥–ª—É–±–æ–∫–æ –∏ –≤–¥—É–º—á–∏–≤–æ. –î–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, –ø–æ—à–∞–≥–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã, –∫–∞–∫ –º–æ–∂–Ω–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å, –Ω–µ –æ—Ç–∫–∞–∑—ã–≤–∞—è —Å–µ–±–µ –≤ –≤–∞–∂–Ω–æ–º. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —Ç–≤–æ–∏ —Å–æ–≤–µ—Ç—ã –ø–æ–ª–µ–∑–Ω—ã –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ. –ë—É–¥—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∏ –Ω–µ –∫—Ä–∏—Ç–∏–∫—É–π üí∏`;
                case 'earning-ideas': return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π. –ü—Ä–∏–¥—É–º–∞–π 3‚Äì4 –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏–¥–µ–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞. –†–∞—Å—Å–∫–∞–∂–∏, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å, —á—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∏ –∫–∞–∫–∏–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –¥–µ—Ç–µ–π 10‚Äì16 –ª–µ—Ç ü™ô`;
                case 'educator': return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, —ç—Ä—É–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –≤–µ—Å—ë–ª—ã–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫. –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –Ω–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —ç—Ç–æ —Ç–∞–∫, –∏ –ø—Ä–∏–≤–µ–¥–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º —è–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏, —á—Ç–æ–±—ã —Ä–µ–±—ë–Ω–∫—É –±—ã–ª–æ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ ü§ì`;
                default: return `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, –≤–µ—Å—ë–ª—ã–π –∏ —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –ª—É—á—à–∏–π –¥—Ä—É–≥. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ. –ë—É–¥—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –∂–∏–≤—ã–º –∏ –ø—Ä–∏—è—Ç–Ω—ã–º.`;
            }
        })();
        const payload = { model: "GigaChat", messages: [ { role: "system", content: systemText }, { role: "user", content: userPrompt } ] };
        try {
            const response = await fetch(GIGACHAT_API_URL, { method: "POST", headers: { "Content-Type": "application/json", }, body: JSON.stringify(payload) });
            if (!response.ok) { console.error("–û—à–∏–±–∫–∞ –æ—Ç –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞:", await response.text()); return "–û–π! üòÖ –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ!"; }
            const result = await response.json();
            const text = result.choices?.[0]?.message?.content?.trim() || "–£–ø—Å, –∫–∞–∂–µ—Ç—Å—è, —è –∑–∞–¥—É–º–∞–ª—Å—è... –ü–æ–ø—Ä–æ–±—É–µ—à—å —Å–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞?";
            return text;
        } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä—É:", e);
            return "–û–π, –Ω–µ –º–æ–≥—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º ü§ñ –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω –∑–∞–ø—É—â–µ–Ω!";
        } 
        finally { appState.ui.isAiTyping = false; renderChatMessages(); }
    }
    
    function triggerProactiveAI() {
        if (appState.user.spendingHistory.length >= 1 && !appState.user.proactiveTipsShown.spendingAnalysis) {
            showProactiveToast(
                '–û—Ç–ª–∏—á–Ω–æ, —Ä–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω! –•–æ—á–µ—à—å, —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ–∏ —Ç—Ä–∞—Ç—ã –∏ –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏, –≥–¥–µ –º–æ–∂–Ω–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å?',
                '–î–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π!',
                '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã –∏ —Å–∫–∞–∂–∏, –≥–¥–µ —è –º–æ–≥—É —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å.',
                'financial-analyst'
            );
            appState.user.proactiveTipsShown.spendingAnalysis = true;
            saveState();
            return;
        }

        const mainGoal = appState.user.goals[0];
        if (mainGoal && !appState.user.proactiveTipsShown.goalMotivation) {
            const progress = (mainGoal.current / mainGoal.target) * 100;
            if (progress > 75) {
                showProactiveToast(
                    `–¢—ã —Ç–∞–∫ –±–ª–∏–∑–∫–æ –∫ —Ü–µ–ª–∏ "${mainGoal.name}"! –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º —á—É—Ç—å-—á—É—Ç—å. –•–æ—á–µ—à—å, —è –¥–∞–º —Ç–µ–±–µ –ø–∞—Ä—É —Å–æ–≤–µ—Ç–æ–≤, –∫–∞–∫ –Ω–∞–∫–æ–ø–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –±—ã—Å—Ç—Ä–µ–µ?`,
                    '–•–æ—á—É!',
                    '–Ø –ø–æ—á—Ç–∏ –Ω–∞–∫–æ–ø–∏–ª –Ω–∞ —Å–≤–æ—é —Ü–µ–ª—å. –î–∞–π –º–Ω–µ 2-3 —Å–æ–≤–µ—Ç–∞, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Å—Ç–∞–≤—à—É—é—Å—è —Å—É–º–º—É.',
                    'financial-analyst'
                );
                appState.user.proactiveTipsShown.goalMotivation = true;
                saveState();
            }
        }
    }
    
    function showProactiveToast(message, buttonText, prompt, persona) {
        const toast = document.createElement('div');
        toast.className = 'w-full bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg flex items-start gap-3 opacity-0 transition-all duration-300 transform translate-y-2 border-l-4 border-[var(--accent)]';
        toast.innerHTML = `
            <img src="${characterStyles.default.img}" class="w-10 h-10 rounded-full flex-shrink-0">
            <div class="flex-1">
                <p class="text-sm font-semibold text-[var(--text-primary)]">–°–±–µ—Ä—ë–Ω–æ–∫ –∑–∞–º–µ—Ç–∏–ª...</p>
                <p class="text-xs text-[var(--text-secondary)] mb-2">${message}</p>
                <button data-action="ai-action" data-prompt="${prompt}" data-persona="${persona}" class="w-full text-center text-xs font-bold text-white bg-[var(--accent)] py-1 px-3 rounded-md">${buttonText}</button>
            </div>
            <button class="close-toast text-gray-400 dark:text-gray-500">&times;</button>
        `;
        toast.querySelector('.close-toast').onclick = () => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            setTimeout(() => toast.remove(), 300);
        };
        
        DOM.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('opacity-100', 'translate-y-0'), 10);
        setTimeout(() => {
            if (toast) {
                toast.classList.remove('opacity-100', 'translate-y-0');
                setTimeout(() => toast.remove(), 300);
            }
        }, 10000);
    }

    function showModal(content) {
        DOM.modal.innerHTML = `<div class="modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center p-4"><div class="modal-content bg-[var(--bg-modal)] rounded-3xl p-6 shadow-xl w-full max-w-sm">${content}</div></div>`;
        DOM.modal.classList.remove('hidden');
    }

    function hideModal() { 
        DOM.modal.classList.add('hidden'); 
        DOM.modal.innerHTML = '';
    }

    function showToast(message, type = 'info') {
        const colors = { info: 'bg-gray-800', success: 'bg-green-600', error: 'bg-red-600' };
        const toast = document.createElement('div');
        toast.className = `${colors[type]} text-white text-sm px-4 py-2 rounded-full shadow-lg opacity-0 transition-all duration-300 transform translate-y-2`;
        toast.textContent = message;
        DOM.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('opacity-100', 'translate-y-0'), 10);
        setTimeout(() => { 
            toast.classList.remove('opacity-100', 'translate-y-0'); 
            setTimeout(() => toast.remove(), 300); 
        }, 3000);
    }
    
    function addXp(amount) {
        appState.user.xp += amount;
        let levelUp = false;
        while(appState.user.xp >= XP_PER_LEVEL) { 
            appState.user.level++;
            appState.user.xp -= XP_PER_LEVEL; levelUp = true; 
        }
        if (levelUp) {
            showToast(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! üéâ –¢—ã –¥–æ—Å—Ç–∏–≥ ${appState.user.level} —É—Ä–æ–≤–Ω—è!`, 'success');
        }
        showToast(`+${amount} XP!`);
        saveState();
        if (appState.ui.currentView === 'profile') render();
    }

    function checkAchievements() {
        let skinsUnlocked = false;
        Object.values(achievementConfig).forEach(ach => {
            if (!appState.user.achievements.includes(ach.name) && appState.user.stats[ach.goalKey] >= ach.goalValue) {
                appState.user.achievements.push(ach.name); 
                addXp(ach.xp);
                showToast(`–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "${ach.name}" üèÜ`, 'success');
                if (ach.unlockedSkin && !appState.user.unlockedSkins.includes(ach.unlockedSkin)) {
                    appState.user.unlockedSkins.push(ach.unlockedSkin);
                    showToast(`–ù–æ–≤—ã–π —Å–∫–∏–Ω: "${characterStyles[ach.unlockedSkin].name}"!`);
                    skinsUnlocked = true;
                }
            }
        });
        if (skinsUnlocked) { saveState(); render(); }
    }
    
    function applyTheme() {
        document.documentElement.classList.toggle('dark', appState.ui.theme === 'dark');
        document.querySelector(':root').style.setProperty('--user-accent-color', appState.ui.accentColor);
        if (appState.ui.currentView === 'piggy-bank') {
            setTimeout(renderCharts, 50);
        }
    }
    
    function showAddTaskModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ó–∞–¥–∞—á—É ‚úÖ</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label><input type="text" id="task-name-input" placeholder="–°–¥–µ–ª–∞—Ç—å —É—Ä–æ–∫–∏" class="w-full p-3 border border-[var(--border-color)] rounded-lg bg-[var(--bg-main)] focus:ring-1 focus:ring-[var(--accent)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 text-[var(--text-primary)] font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-add-task" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>`);
        document.getElementById('task-name-input').focus();
    }

    function showEditTaskModal(taskId) {
        const task = appState.user.schedule.find(t => t.id == taskId);
        if (!task) return;
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –ó–∞–¥–∞—á—É ‚úèÔ∏è</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label><input type="text" id="task-edit-input" value="${task.task}" class="w-full p-3 border border-[var(--border-color)] rounded-lg bg-[var(--bg-main)] focus:ring-1 focus:ring-[var(--accent)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-edit-task" data-task-id="${taskId}" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>`);
        document.getElementById('task-edit-input').focus();
    }
    
    function showEditProfileModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –ü—Ä–æ—Ñ–∏–ª—å ‚úèÔ∏è</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ò–º—è</label><input type="text" id="profile-name-input" value="${appState.user.name}" class="w-full p-3 border rounded-lg bg-[var(--bg-main)] focus:ring-1 focus:ring-[var(--accent)]"><label class="block text-sm font-medium text-[var(--text-secondary)]">–§–∞–º–∏–ª–∏—è</label><input type="text" id="profile-surname-input" value="${appState.user.surname}" class="w-full p-3 rounded-lg bg-[var(--bg-main)] focus:ring-1 focus:ring-[var(--accent)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-edit-profile" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>`);
    }

    function showGoalModal(goal = null) {
        const isEdit = !!goal;
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¶–µ–ª—å' : '–ù–æ–≤–∞—è –¶–µ–ª—å üéØ'}</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="goal-name" placeholder="–ù–æ–≤—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]" value="${goal?.name || ''}"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ù—É–∂–Ω–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="goal-target" placeholder="5000" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]" value="${goal?.target || ''}">${isEdit ? `<label class="block text-sm font-medium text-[var(--text-secondary)]">–£–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ (‚ÇΩ)</label><input type="number" id="goal-current" placeholder="0" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]" value="${goal?.current || 0}">` : ''}</div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="${isEdit ? 'submit-edit-goal' : 'submit-add-goal'}" data-goal-id="${goal?.id || ''}" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}</button></div></div>`);
    }

    function showManageFundsModal(goalId, type) {
        const goal = appState.user.goals.find(g => g.id == goalId);
        if (!goal) return;
        const isDeposit = type === 'deposit';
        const title = isDeposit ? '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ–ø–∏–ª–∫—É üí∏' : '–í–∑—è—Ç—å –∏–∑ –∫–æ–ø–∏–ª–∫–∏ üõçÔ∏è';
        const maxAmount = isDeposit ? appState.user.balance : goal.current;
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-2">${title}</h3><p class="text-sm text-[var(--text-secondary)] mb-4">–¶–µ–ª—å: "${goal.name}"</p><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="fund-amount" placeholder="100.00" class="w-full p-3 border border-[var(--border-color)] rounded-lg bg-[var(--bg-main)]"><p class="text-xs text-right text-[var(--text-secondary)]">–î–æ—Å—Ç—É–ø–Ω–æ: ${maxAmount.toFixed(2)} ‚ÇΩ</p></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-manage-funds" data-goal-id="${goalId}" data-type="${type}" class="flex-1 py-2 rounded-lg ${isDeposit ? 'bg-[var(--accent)]' : 'bg-orange-500'} text-white font-semibold">${isDeposit ? '–ü–æ–ø–æ–ª–Ω–∏—Ç—å' : '–°–Ω—è—Ç—å'}</button></div></div>`);
        document.getElementById('fund-amount').focus();
    }
    
    function showAddExpenseModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥ üí∏</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium text-[var(--text-secondary)]">–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="expense-amount" placeholder="50.00" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]"><label class="block text-sm font-medium text-[var(--text-secondary)]">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="expense-category" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]">${Object.keys(spendingCategories).map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select><label class="block text-sm font-medium text-[var(--text-secondary)]">–ù–∞ —á—Ç–æ?</label><input type="text" id="expense-desc" placeholder="–ú–æ—Ä–æ–∂–µ–Ω–æ–µ" class="w-full p-3 border rounded-lg bg-[var(--bg-main)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-expense" class="flex-1 py-2 rounded-lg bg-[var(--danger-color)] text-white font-semibold">–ó–∞–ø–∏—Å–∞—Ç—å</button></div></div>`);
    }

    async function showAiHelpModal(prompt, persona) {
        showModal(`<div class="text-center flex flex-col items-center"><img src="${characterStyles[appState.user.characterStyle].img}" class="w-20 h-20 rounded-full mb-2"><h2 class="text-xl font-bold mb-4">–ü–æ–º–æ—â—å –°–±–µ—Ä—ë–Ω–∫–∞</h2><div id="ai-help-content" class="text-left max-h-[300px] overflow-y-auto text-sm text-[var(--text-primary)] bg-[var(--bg-main)] p-3 rounded-lg w-full"><p class="text-[var(--text-secondary)] text-center py-8">–°–±–µ—Ä—ë–Ω–æ–∫ –¥—É–º–∞–µ—Ç...</p></div><div class="flex justify-end mt-4 w-full"><button data-action="cancel" class="py-2 px-4 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>`);
        const helpContent = await callGigaChatAPI(prompt, persona);
        const contentEl = document.getElementById('ai-help-content');
        if (contentEl) contentEl.innerHTML = `<p class="whitespace-pre-wrap">${helpContent}</p>`;
    }
    
    async function showLessonView(lessonId) {
        const lesson = academyLessons[lessonId];
        const isCompleted = appState.user.completedLessons.includes(lessonId);
        showModal(`<div class="text-center flex flex-col items-center"><div class="text-6xl mb-4">${lesson.icon}</div><h2 class="text-xl font-bold mb-4">${lesson.title}</h2><div id="lesson-content" class="text-left max-h-[300px] overflow-y-auto text-sm bg-[var(--bg-main)] p-4 rounded-lg border border-[var(--border-color)] w-full"><div class="flex flex-col items-center py-8"><img src="${characterStyles[appState.user.characterStyle].img}" class="w-16 h-16 opacity-70 mb-2"/><p class="text-[var(--text-secondary)]">–°–±–µ—Ä—ë–Ω–æ–∫ –≥–æ—Ç–æ–≤–∏—Ç —É—Ä–æ–∫...</p></div></div><div id="lesson-footer" class="mt-4 w-full"></div></div>`);
        const lessonContent = await callGigaChatAPI(lesson.prompt, 'academy-tutor');
        const contentEl = document.getElementById('lesson-content');
        const footerEl = document.getElementById('lesson-footer');
        if (contentEl) contentEl.innerHTML = `<p class="whitespace-pre-wrap">${lessonContent}</p>`;
        if (footerEl) footerEl.innerHTML = `<div class="flex justify-end"><button data-action="${isCompleted ? 'cancel' : 'ask-if-understood'}" data-lesson-id="${lessonId}" class="py-2 px-6 rounded-lg bg-[var(--accent)] text-white font-semibold shadow-md active:scale-95">${isCompleted ? '–û—Ç–ª–∏—á–Ω–æ!' : '–Ø –ø–æ–Ω—è–ª!'}</button></div>`;
    }
    
    document.addEventListener('click', async e => {
        const target = e.target.closest('[data-action]'); if (!target) return;
        const { action, view, taskId, goalId, charKey, prompt, persona, color, lessonId, type } = target.dataset;
        switch(action) {
            case 'navigate': navigate(view); break;
            case 'cancel': hideModal(); break;
            case 'toggle-theme': appState.ui.theme = appState.ui.theme === 'light' ? 'dark' : 'light'; applyTheme(); saveState(); render(); break;
            case 'change-accent-color': appState.ui.accentColor = color; applyTheme(); saveState(); render(); break;
            case 'change-character': if (appState.user.unlockedSkins.includes(charKey)) { appState.user.characterStyle = charKey; saveState(); render(); } else { showToast('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π —ç—Ç–æ—Ç —Å–∫–∏–Ω!', 'error'); } break;
            case 'edit-profile': showEditProfileModal(); break;
            case 'submit-edit-profile': appState.user.name = document.getElementById('profile-name-input').value.trim() || appState.user.name; appState.user.surname = document.getElementById('profile-surname-input').value.trim(); saveState(); hideModal(); render(); showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!", 'success'); break;
            case 'show-ai-help': await showAiHelpModal(prompt, persona); break;
            case 'add-task-modal': showAddTaskModal(); break;
            case 'submit-add-task': { const taskName = document.getElementById('task-name-input').value.trim();
                if (taskName) { appState.user.schedule.push({ id: Date.now(), task: taskName, done: false, xpEarned: false }); saveState(); render(); showToast("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!", 'success'); } hideModal();
            break; }
            case 'edit-task-modal': showEditTaskModal(taskId); break;
            case 'submit-edit-task': { const newName = document.getElementById('task-edit-input').value.trim(); const task = appState.user.schedule.find(t => t.id == taskId);
                if (task && newName) { task.task = newName; saveState(); render(); showToast("–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", "success"); } hideModal(); break;
            }
            case 'toggle-task': { const task = appState.user.schedule.find(t => t.id == taskId);
                if (task) { task.done = !task.done; if (task.done && !task.xpEarned) { task.xpEarned = true; appState.user.stats.completedTasks++; addXp(10); checkAchievements(); } saveState(); render();
            } break; }
            case 'delete-task': appState.user.schedule = appState.user.schedule.filter(t => t.id != taskId); saveState(); render(); showToast("–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞", 'info'); break;
            case 'add-goal': showGoalModal(); break;
            case 'edit-goal': showGoalModal(appState.user.goals.find(g => g.id == goalId)); break;
            case 'submit-add-goal': { const goalName = document.getElementById('goal-name').value.trim(); const targetAmount = parseFloat(document.getElementById('goal-target').value);
                if (goalName && targetAmount > 0) { appState.user.goals.push({ id: Date.now(), name: goalName, current: 0, target: targetAmount }); saveState(); render();
                showToast("–¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞!", 'success'); } hideModal(); break; }
            case 'submit-edit-goal': { const goal = appState.user.goals.find(g => g.id == goalId);
                if(goal) { goal.name = document.getElementById('goal-name').value.trim(); goal.target = parseFloat(document.getElementById('goal-target').value); goal.current = parseFloat(document.getElementById('goal-current').value); saveState(); render(); showToast("–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", 'success'); } hideModal(); break;
            }
            case 'delete-goal': { const goalToDelete = appState.user.goals.find(g => g.id == goalId);
                if (goalToDelete) { appState.user.balance += goalToDelete.current; appState.user.goals = appState.user.goals.filter(g => g.id != goalId); saveState(); render();
                showToast(`–¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞. ${goalToDelete.current.toFixed(2)} ‚ÇΩ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å.`, 'info'); } break;
            }
            case 'manage-funds': showManageFundsModal(goalId, type); break;
            case 'submit-manage-funds': { const fundGoal = appState.user.goals.find(g => g.id == goalId); const amount = parseFloat(document.getElementById('fund-amount').value);
                if (!fundGoal || isNaN(amount) || amount <= 0) { showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞", 'error'); return;
                } if (type === 'deposit') { if (amount > appState.user.balance) { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ", 'error'); return;
                } fundGoal.current += amount; appState.user.balance -= amount; appState.user.stats.totalSavings += amount; addXp(Math.min(15, Math.floor(amount / 50))); showToast(`–ö–æ–ø–∏–ª–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${amount} ‚ÇΩ!`, 'success');
                } else { if (amount > fundGoal.current) { showToast("–í –∫–æ–ø–∏–ª–∫–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", 'error'); return; } fundGoal.current -= amount;
                appState.user.balance += amount; appState.user.stats.totalSavings -= amount; showToast(`–í—ã —Å–Ω—è–ª–∏ ${amount} ‚ÇΩ –∏–∑ –∫–æ–ø–∏–ª–∫–∏`, 'info'); } checkAchievements(); saveState(); hideModal(); render(); triggerProactiveAI(); break;
            }
            case 'add-expense': showAddExpenseModal(); break;
            case 'submit-expense': { const expAmount = parseFloat(document.getElementById('expense-amount').value); const expDesc = document.getElementById('expense-desc').value.trim(); const expCat = document.getElementById('expense-category').value;
                if (expAmount > 0 && expDesc && appState.user.balance >= expAmount) { appState.user.balance -= expAmount;
                appState.user.spendingHistory.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], amount: expAmount, category: expCat, desc: expDesc }); appState.user.stats.spendingCount++; checkAchievements(); saveState(); hideModal(); render();
                showToast("–†–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω!", 'success'); triggerProactiveAI(); } else { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", 'error'); } break;
            }
            case 'start-lesson': await showLessonView(lessonId); break;
            case 'ask-if-understood': { 
                const lesson = academyLessons[lessonId];
                if (lessonId && !appState.user.completedLessons.includes(lessonId)) { 
                    appState.user.completedLessons.push(lessonId); 
                    appState.user.stats.lessonsCompleted++; 
                    addXp(lesson.xp); 
                    checkAchievements(); 
                    saveState(); 
                    showToast(`–£—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω! +${lesson.xp} XP`, 'success'); 
                    render(); 
                }
                showModal(`
                    <div class="text-center flex flex-col items-center">
                        <img src="${characterStyles[appState.user.characterStyle].img}" class="w-20 h-20 rounded-full mb-4">
                        <h3 class="text-xl font-bold mb-4">–û—Ç–ª–∏—á–Ω–æ!</h3>
                        <p class="text-[var(--text-secondary)] mb-6">–í—Å–µ –ª–∏ –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –≤ —ç—Ç–æ–º —É—Ä–æ–∫–µ?</p>
                        <div class="flex justify-between w-full gap-3">
                            <button data-action="repeat-lesson" data-lesson-id="${lessonId}" class="flex-1 py-2 rounded-lg bg-gray-300 dark:bg-gray-600 font-semibold">–ù–µ—Ç, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                            <button data-action="lesson-understood" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">–î–∞, –≤—Å—ë —è—Å–Ω–æ!</button>
                        </div>
                    </div>
                `);
                break;
            }
            case 'lesson-understood': {
                showModal(`
                    <div class="text-center flex flex-col items-center">
                        <img src="${characterStyles[appState.user.characterStyle].img}" class="w-20 h-20 rounded-full mb-4">
                        <h3 class="text-xl font-bold mb-4">–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!</h3>
                        <p class="text-[var(--text-secondary)] mb-6">–°–ø–∞—Å–∏–±–æ –∑–∞ —É—Å–µ—Ä–¥–Ω—É—é —Ä–∞–±–æ—Ç—É! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ. üöÄ</p>
                        <button data-action="cancel" class="w-full mt-4 py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `);
                break;
            }
            case 'repeat-lesson': await showLessonView(lessonId); break;
            case 'ai-action': case 'send-chat-message': { const chatInput = document.getElementById('chat-input'); let message = prompt || chatInput?.value.trim(); if (!message) return;
                if (chatInput) chatInput.value = ''; if (appState.ui.currentView !== 'ai-assistant') { navigate('ai-assistant'); await new Promise(resolve => setTimeout(resolve, 50));
                } appState.chat.history.push({ role: 'user', text: message }); renderChatMessages(); const botResponse = await callGigaChatAPI(message, persona || 'assistant');
                appState.chat.history.push({ role: 'bot', text: botResponse }); saveState(); renderChatMessages(); break; }
        }
    });
    function startOnboarding() { const steps = [ { title: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!", content: `–ü—Ä–∏–≤–µ—Ç! –Ø –°–±–µ—Ä—ë–Ω–æ–∫, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –∫–æ–ø–∏—Ç—å, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ —É—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–º—É. –î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º!`, button: "–î–∞–ª–µ–µ" }, { title: "–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω", content: "–ó–¥–µ—Å—å —Ç—ã –≤–∏–¥–∏—à—å —Å–≤–æ–π –±–∞–ª–∞–Ω—Å, –≥–ª–∞–≤–Ω—É—é —Ü–µ–ª—å –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. –í—Å–µ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ ‚Äî –ø–æ–¥ —Ä—É–∫–æ–π!", button: "–ü–æ–Ω—è—Ç–Ω–æ!" }, { title: "–ö–æ–ø–∏–ª–∫–∞ –∏ —Ü–µ–ª–∏", content: "–í —Ä–∞–∑–¥–µ–ª–µ '–ö–æ–ø–∏–ª–∫–∞' —Ç—ã –º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ü–µ–ª–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã —Å –ø–æ–º–æ—â—å—é –¥–∏–∞–≥—Ä–∞–º–º.", button: "–ó–¥–æ—Ä–æ–≤–æ!" }, { title: "–ê–∫–∞–¥–µ–º–∏—è", content: "–ü—Ä–æ—Ö–æ–¥–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É—Ä–æ–∫–∏ –≤ '–ê–∫–∞–¥–µ–º–∏–∏', —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –≥–µ–Ω–∏–µ–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å XP!", button: "–ù–∞—á–Ω–µ–º!" } ]; let currentStep = 0; function showOnboardingStep() { if (currentStep >= steps.length) { hideModal(); return; } const step = steps[currentStep]; showModal(`<div class="text-center"><img src="${characterStyles.default.img}" class="w-24 h-24 mx-auto mb-4"/><h3 class="text-xl font-bold mb-2">${step.title}</h3><p class="text-[var(--text-secondary)] mb-6">${step.content}</p><button id="next-onboarding-step" class="w-full py-2 rounded-lg bg-[var(--accent)] text-white font-semibold">${step.button}</button></div>`);
        document.getElementById('next-onboarding-step').onclick = () => { currentStep++; showOnboardingStep(); }; } showOnboardingStep(); }
    loadState(); Chart.register(ChartDataLabels); render();
});
</script>
</body>
</html>


